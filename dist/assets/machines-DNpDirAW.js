import{b as e,r as t,c as a}from"./vue-vendor-BY5hdAT7.js";import{l as s,j as n,h as r,m as i,f as o}from"./index-Dur0lEaU.js";const c=new class{constructor(){this.ws=null,this.url=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectInterval=3e3,this.isConnecting=!1,this.isManualClose=!1,this.listeners=new Map,this.heartbeatInterval=null,this.heartbeatTimeout=null,this.lastHeartbeat=null,this.config={heartbeatInterval:3e4,heartbeatTimeout:5e3,reconnectDelay:3e3,maxReconnectAttempts:5}}connect(e="ws://localhost:8000/api/v1/ws",t={}){return this.isConnecting||this.ws&&this.ws.readyState===WebSocket.CONNECTING?(s.warn("WebSocket já está conectando"),Promise.resolve()):this.ws&&this.ws.readyState===WebSocket.OPEN?(s.warn("WebSocket já está conectado"),Promise.resolve()):(this.url=e,this.isConnecting=!0,this.isManualClose=!1,new Promise((a,n)=>{try{s.info(`Conectando ao WebSocket: ${e}`),this.ws=new WebSocket(e);const r=setTimeout(()=>{this.ws.readyState===WebSocket.CONNECTING&&(this.ws.close(),n(new Error("Timeout na conexão WebSocket")))},t.timeout||1e4);this.ws.onopen=e=>{clearTimeout(r),this.isConnecting=!1,this.reconnectAttempts=0,s.info("WebSocket conectado com sucesso"),this.emit("connected",{event:e}),this.startHeartbeat(),a()},this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);this.handleMessage(t)}catch(t){s.error("Erro ao processar mensagem WebSocket:",t),this.emit("error",{error:t,rawData:e.data})}},this.ws.onclose=e=>{clearTimeout(r),this.isConnecting=!1,this.stopHeartbeat(),s.info(`WebSocket desconectado. Code: ${e.code}, Reason: ${e.reason}`),this.emit("disconnected",{event:e}),!this.isManualClose&&this.shouldReconnect()&&this.scheduleReconnect()},this.ws.onerror=e=>{clearTimeout(r),this.isConnecting=!1,s.error("Erro no WebSocket:",e),this.emit("error",{error:e}),this.ws.readyState===WebSocket.CONNECTING&&n(e)}}catch(r){this.isConnecting=!1,s.error("Erro ao criar WebSocket:",r),n(r)}}))}disconnect(){this.isManualClose=!0,this.stopHeartbeat(),this.ws&&(this.ws.readyState!==WebSocket.OPEN&&this.ws.readyState!==WebSocket.CONNECTING||this.ws.close(1e3,"Desconexão manual"),this.ws=null),s.info("WebSocket desconectado manualmente")}send(e,t={}){if(!this.isConnected())return s.warn("WebSocket não está conectado. Mensagem não enviada:",{type:e,data:t}),!1;try{const a={type:e,data:t,timestamp:Date.now()};return this.ws.send(JSON.stringify(a)),s.debug("Mensagem enviada via WebSocket:",a),!0}catch(a){return s.error("Erro ao enviar mensagem WebSocket:",a),this.emit("error",{error:a}),!1}}isConnected(){return this.ws&&this.ws.readyState===WebSocket.OPEN}on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}off(e,t){this.listeners.has(e)&&this.listeners.get(e).delete(t)}emit(e,t={}){this.listeners.has(e)&&this.listeners.get(e).forEach(a=>{try{a(t)}catch(n){s.error(`Erro no listener do evento ${e}:`,n)}})}handleMessage(e){const{type:t,data:a,timestamp:n}=e;"pong"!==t?(s.debug("Mensagem recebida via WebSocket:",e),this.emit(t,{data:a,timestamp:n}),this.emit("message",e)):this.handleHeartbeatResponse()}startHeartbeat(){this.stopHeartbeat(),this.heartbeatInterval=setInterval(()=>{this.isConnected()&&(this.lastHeartbeat=Date.now(),this.send("ping"),this.heartbeatTimeout=setTimeout(()=>{s.warn("Heartbeat timeout - reconectando..."),this.ws.close(1006,"Heartbeat timeout")},this.config.heartbeatTimeout))},this.config.heartbeatInterval)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null),this.heartbeatTimeout&&(clearTimeout(this.heartbeatTimeout),this.heartbeatTimeout=null)}handleHeartbeatResponse(){this.heartbeatTimeout&&(clearTimeout(this.heartbeatTimeout),this.heartbeatTimeout=null);const e=Date.now()-this.lastHeartbeat;this.emit("heartbeat",{latency:e})}shouldReconnect(){return this.reconnectAttempts<this.config.maxReconnectAttempts}scheduleReconnect(){if(!this.shouldReconnect())return s.error("Máximo de tentativas de reconexão atingido"),void this.emit("maxReconnectAttemptsReached");this.reconnectAttempts++;const e=this.config.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);s.info(`Tentativa de reconexão ${this.reconnectAttempts}/${this.config.maxReconnectAttempts} em ${e}ms`),setTimeout(()=>{this.isManualClose||this.connect(this.url).catch(e=>{s.error("Erro na tentativa de reconexão:",e)})},e)}getStats(){return{isConnected:this.isConnected(),reconnectAttempts:this.reconnectAttempts,lastHeartbeat:this.lastHeartbeat,url:this.url,readyState:this.ws?this.ws.readyState:null,listeners:Array.from(this.listeners.keys())}}},l=e("machines",()=>{const e=t([]),l=t(null),u=t(!1),h=t(null),d=t(null),m=t(!1),v=t(null),g=t({status:"all",location:"",department:"",search:""}),p=t({autoRefresh:!0,refreshRate:3e4,realTimeUpdates:!0,alertsEnabled:!0}),f=t({totalMachines:0,onlineMachines:0,offlineMachines:0,warningMachines:0,criticalMachines:0,avgCpuUsage:0,avgMemoryUsage:0,avgDiskUsage:0,systemUptime:0}),w=t([]),b=t({}),S=a(()=>{let t=e.value;if("all"!==g.value.status&&(t=t.filter(e=>e.status===g.value.status)),g.value.location&&(t=t.filter(e=>{var t;return null==(t=e.location)?void 0:t.toLowerCase().includes(g.value.location.toLowerCase())})),g.value.department&&(t=t.filter(e=>{var t;return null==(t=e.department)?void 0:t.toLowerCase().includes(g.value.department.toLowerCase())})),g.value.search){const e=g.value.search.toLowerCase();t=t.filter(t=>{var a,s,n,r;return(null==(a=t.name)?void 0:a.toLowerCase().includes(e))||(null==(s=t.hostname)?void 0:s.toLowerCase().includes(e))||(null==(n=t.ip)?void 0:n.includes(e))||(null==(r=t.user)?void 0:r.toLowerCase().includes(e))})}return t}),M=a(()=>e.value.filter(e=>"online"===e.status)),y=a(()=>e.value.filter(e=>"offline"===e.status)),k=a(()=>e.value.filter(e=>"critical"===e.status)),C=a(()=>e.value.filter(e=>"warning"===e.status)),I=async(t=!1)=>{u.value=!0,h.value=null;try{const a=await n.machines.getAll({forceRefresh:t,cacheKey:"machines:all",cacheTTL:6e4});return e.value=a.data||[],W(),d.value=new Date,{success:!0,data:a.data}}catch(a){const e=r(a);return h.value="Erro ao carregar máquinas: "+e.message,s.error("Erro ao buscar máquinas:",a),{success:!1,error:e.message}}finally{u.value=!1}},W=()=>{const t=e.value.length,a=e.value.filter(e=>"online"===e.status).length,s=e.value.filter(e=>"offline"===e.status).length,n=e.value.filter(e=>"warning"===e.status).length,r=e.value.filter(e=>"critical"===e.status).length,i=e.value.filter(e=>"online"===e.status&&e.performance),o=i.length>0?i.reduce((e,t)=>{var a;return e+((null==(a=t.performance)?void 0:a.cpu)||0)},0)/i.length:0,c=i.length>0?i.reduce((e,t)=>{var a;return e+((null==(a=t.performance)?void 0:a.memory)||0)},0)/i.length:0,l=i.length>0?i.reduce((e,t)=>{var a;return e+((null==(a=t.performance)?void 0:a.disk)||0)},0)/i.length:0;f.value={totalMachines:t,onlineMachines:a,offlineMachines:s,warningMachines:n,criticalMachines:r,avgCpuUsage:Math.round(100*o)/100,avgMemoryUsage:Math.round(100*c)/100,avgDiskUsage:Math.round(100*l)/100,systemUptime:t>0?Math.round(a/t*100*100)/100:0}},T=(e,t)=>{var a,s,n,r;b.value[e]||(b.value[e]=[]);const i=b.value[e];i.push({timestamp:new Date,cpu:(null==(a=t.performance)?void 0:a.cpu)||0,memory:(null==(s=t.performance)?void 0:s.memory)||0,disk:(null==(n=t.performance)?void 0:n.disk)||0,network:(null==(r=t.performance)?void 0:r.network)||0}),i.length>100&&i.splice(0,i.length-100)};let E=null;const R=()=>{p.value.autoRefresh&&!E&&(E=setInterval(()=>{I()},p.value.refreshRate))},A=()=>{E&&(clearInterval(E),E=null)},D=t=>{const{machineId:a,updates:n}=t,r=e.value.findIndex(e=>e.id===a);-1!==r?(e.value[r]={...e.value[r],...n,lastUpdate:(new Date).toISOString()},s.debug(`Máquina ${a} atualizada via WebSocket`)):(e.value.push({id:a,...n,lastUpdate:(new Date).toISOString()}),s.debug(`Nova máquina ${a} adicionada via WebSocket`)),d.value=(new Date).toISOString()},N=t=>{const{machineId:a,metrics:s}=t,n=e.value.find(e=>e.id===a);n&&(n.metrics={...n.metrics,...s,timestamp:(new Date).toISOString()},T(a,s)),updateAggregatedMetrics()},x=e=>{const{machineId:t,alert:a}=e;w.value.unshift({id:Date.now(),machineId:t,...a,timestamp:(new Date).toISOString(),read:!1}),w.value.length>100&&(w.value=w.value.slice(0,100)),s.info(`Novo alerta para máquina ${t}:`,a)},H=t=>{const{machines:a}=t;e.value=a.map(e=>({...e,lastUpdate:(new Date).toISOString()})),d.value=(new Date).toISOString(),updateAggregatedMetrics(),s.info(`Lista de máquinas atualizada via WebSocket: ${a.length} máquinas`)};return{machines:e,selectedMachine:l,loading:u,error:h,lastUpdate:d,wsConnected:m,wsError:v,filters:g,monitoringConfig:p,metrics:f,alerts:w,performanceHistory:b,filteredMachines:S,onlineMachines:M,offlineMachines:y,criticalMachines:k,warningMachines:C,fetchMachines:I,fetchMachineStatus:async t=>{try{const a=await n.machines.getStatus(t,{cacheKey:`machines:${t}:status`,cacheTTL:1e4}),s=e.value.findIndex(e=>e.id===t);return-1!==s&&(e.value[s]={...e.value[s],...a.data},W()),{success:!0,data:a.data}}catch(a){const e=r(a);return s.error(`Erro ao buscar status da máquina ${t}:`,a),{success:!1,error:e.message}}},registerMachine:async t=>{u.value=!0,h.value=null;try{const a=await i.register(t);return e.value.push(a.data),W(),{success:!0,data:a.data}}catch(a){const e=r(a);return h.value="Erro ao registrar máquina: "+e.message,s.error("Erro ao registrar máquina:",a),{success:!1,error:e.message}}finally{u.value=!1}},updateMachineStatus:async t=>{try{const a=await i.updateStatus(t),s=e.value.findIndex(e=>e.id===t.machineId);return-1!==s&&(e.value[s]={...e.value[s],...a.data},W(),T(t.machineId,a.data)),{success:!0,data:a.data}}catch(a){const e=r(a);return s.error("Erro ao atualizar status da máquina:",a),{success:!1,error:e.message}}},selectMachine:e=>{l.value=e},clearSelection:()=>{l.value=null},setFilters:e=>{g.value={...g.value,...e}},clearFilters:()=>{g.value={status:"all",location:"",department:"",search:""}},updateMetrics:W,addPerformanceData:T,connectWebSocket:async()=>{try{const e=o().token,t=e?`ws://localhost:8000/api/v1/ws?token=${e}`:"ws://localhost:8000/api/v1/ws";await c.connect(t),c.on("connected",()=>{m.value=!0,s.info("WebSocket conectado - solicitando dados iniciais"),c.send("subscribe",{type:"machines"})}),c.on("disconnected",()=>{m.value=!1,s.warn("WebSocket desconectado")}),c.on("machine_update",({data:e})=>{D(e)}),c.on("machine_metrics",({data:e})=>{N(e)}),c.on("machine_alert",({data:e})=>{x(e)}),c.on("machines_list",({data:e})=>{H(e)}),c.on("error",({error:e})=>{s.error("Erro no WebSocket:",e),m.value=!1})}catch(e){s.error("Erro ao conectar WebSocket:",e),m.value=!1}},disconnectWebSocket:()=>{c.disconnect(),m.value=!1},startAutoRefresh:R,stopAutoRefresh:A,updateMonitoringConfig:e=>{p.value={...p.value,...e},p.value.autoRefresh?(A(),R()):A()},handleMachineUpdate:D,handleMachineMetrics:N,handleMachineAlert:x,handleMachinesList:H}});export{l as u};
//# sourceMappingURL=machines-DNpDirAW.js.map
