# LevitIIS - Nginx TLS reverse proxy configuration (Windows)
# Place this file under your Nginx conf.d directory and adjust certificate paths and server_name as needed.
# This configuration proxies HTTPS traffic to FastAPI (Uvicorn) at 127.0.0.1:8000 and the React dashboard at 127.0.0.1:3000.

# Global SSL settings (modern TLS)
# You can also place these in nginx.conf under http { } if preferred
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

# API - FastAPI backend
server {
  listen              443 ssl http2;
  server_name         api.levitiis.local;  # adjust to your real domain

  # Certificates (use real certificate files or self-signed for testing)
  ssl_certificate     C:/nginx/certs/api/fullchain.pem;
  ssl_certificate_key C:/nginx/certs/api/privkey.pem;

  # TLS hardening
  ssl_protocols       TLSv1.2 TLSv1.3;
  ssl_ciphers         'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:HIGH:!aNULL:!MD5:!RC4:!3DES:!CAMELLIA:!DES:!SSLv3';
  ssl_prefer_server_ciphers on;
  ssl_session_timeout 1d;
  ssl_session_cache   shared:MozSSL:10m;
  ssl_session_tickets off;

  # Security headers
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "DENY" always;
  add_header Referrer-Policy "no-referrer" always;
  add_header Content-Security-Policy "default-src 'self'; connect-src 'self' https:; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self'" always;

  # Preserve client IP and auth headers
  proxy_set_header X-Real-IP       $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header Host            $host;
  proxy_set_header Authorization   $http_authorization;

  # Increase header/body limits if needed
  client_max_body_size 25m;

  # API routing (no path rewrite; FastAPI serves /api/v1/*)
  location / {
    proxy_pass          http://127.0.0.1:8000;
    proxy_http_version  1.1;
    proxy_set_header    Upgrade $http_upgrade;
    proxy_set_header    Connection $connection_upgrade;
    proxy_read_timeout  300s;
    proxy_send_timeout  300s;
  }

  # Optional: health check
  location = /healthz {
    proxy_pass http://127.0.0.1:8000/healthz;
  }
}

# Dashboard - React frontend
server {
  listen              443 ssl http2;
  server_name         app.levitiis.local;  # adjust to your real domain

  ssl_certificate     C:/nginx/certs/app/fullchain.pem;
  ssl_certificate_key C:/nginx/certs/app/privkey.pem;

  # TLS hardening (same as API)
  ssl_protocols       TLSv1.2 TLSv1.3;
  ssl_ciphers         'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:HIGH:!aNULL:!MD5:!RC4:!3DES:!CAMELLIA:!DES:!SSLv3';
  ssl_prefer_server_ciphers on;
  ssl_session_timeout 1d;
  ssl_session_cache   shared:MozSSL:10m;
  ssl_session_tickets off;

  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "DENY" always;
  add_header Referrer-Policy "no-referrer" always;
  add_header Content-Security-Policy "default-src 'self'; connect-src 'self' https: ws:; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self'" always;

  proxy_set_header X-Real-IP       $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header Host            $host;

  client_max_body_size 25m;

  location / {
    proxy_pass         http://127.0.0.1:3000;
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection $connection_upgrade;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
  }
}

# Optional HTTP -> HTTPS redirect for both hosts
server {
  listen      80;
  server_name api.levitiis.local app.levitiis.local;
  return 301 https://$host$request_uri;
}